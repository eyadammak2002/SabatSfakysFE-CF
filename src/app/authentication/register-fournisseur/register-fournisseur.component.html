<!-- register-fournisseur.component.html -->
<div class="regis-container" style="background: url('assets/logo.png') no-repeat center center/cover;">
  <div class="card mx-auto">
    <div class="card-body position-relative">

      <!-- Bouton Retour en haut à gauche -->
      <button class="btn btn-outline-secondary position-absolute" style="top: 10px; left: 10px;" (click)="goBack()">
        <i class="bi bi-arrow-left"></i> Retour
      </button>

      <!-- Titre avec icône de client centré -->
      <div class="text-center mt-4 mb-5">
        <i class="bi bi-shop" style="font-size: 2rem; display: block; margin-bottom: 10px;"></i>
        <h3>Inscription</h3>
      </div>

      <!-- Indicateur de progression -->
      <div class="wizard-progress mb-4">
        <div class="progress" style="height: 8px;">
          <div class="progress-bar" role="progressbar" [style.width.%]="getProgressPercentage()" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <div class="d-flex justify-content-between mt-2">
          <span [ngClass]="{'active-step': currentStep === 1, 'text-success': currentStep > 1, 'text-muted': currentStep < 1}">Informations</span>
          <span [ngClass]="{'active-step': currentStep === 2, 'text-success': currentStep > 2, 'text-muted': currentStep < 2}">Logo</span>
          <span [ngClass]="{'active-step': currentStep === 3, 'text-success': currentStep > 3, 'text-muted': currentStep < 3}">Écologie</span>
          <span [ngClass]="{'active-step': currentStep === 4, 'text-success': currentStep > 4, 'text-muted': currentStep < 4}">Validation</span>
        </div>
      </div>

      <form *ngIf="!isSuccessful" (ngSubmit)="onSubmit()" class="mb-3">
        <!-- Étape 1: Informations de base -->
        <div *ngIf="currentStep === 1">
          <h4 class="mb-3 text-primary"><i class="bi bi-person-vcard me-2"></i>Informations de base</h4>
          
          <!-- Nom -->
          <div class="form-col mb-3 widh80">
            <label for="username" class="form-label">Nom de l'entreprise</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-person"></i></span>
              <input id="username" [(ngModel)]="form.username" #username="ngModel" name="username" type="text" class="form-control"       placeholder="Nom de l'entreprise"   minlength="2"    maxlength="50"     pattern="^[a-zA-ZÀ-ÿ\s\-'&.]+$" required />
            </div>
            <div *ngIf="username.invalid && (username.dirty || username.touched)" class="text-danger mt-1">
              <small *ngIf="username.errors?.['required']">Le nom de l'entreprise est obligatoire</small>
              <small *ngIf="username.errors?.['minlength']">Le nom doit contenir au moins 2 caractères</small>
              <small *ngIf="username.errors?.['maxlength']">Le nom ne peut pas dépasser 50 caractères</small>
              <small *ngIf="username.errors?.['pattern']">Le nom ne peut contenir que des lettres, espaces, tirets et apostrophes</small>
            </div>
          </div>

          <!-- Email -->
          <div class="form-col mb-3 widh80">
            <label for="email" class="form-label">Email professionnel</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-envelope"></i></span>
              <input id="email" [(ngModel)]="form.email" name="email" type="email" class="form-control" placeholder="Email" required email #email="ngModel" />
            </div>
            <div *ngIf="email.invalid && (email.dirty || email.touched)" class="text-danger">
              <small *ngIf="email.errors?.['required']">L'email est requis.</small>
              <small *ngIf="email.errors?.['email']">Format d'email invalide.</small>
            </div>
          </div>

          <!-- Adresse -->
          <div class="form-col mb-3 widh80">
            <label for="adresse" class="form-label">Adresse Complète</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
              <input
                id="adresse"
                [(ngModel)]="form.adresse"
                name="adresse"
                type="text"
                class="form-control"
                placeholder="Adresse"
                required
                minlength="5"
                #adresse="ngModel"
              />
            </div>
            <div *ngIf="adresse.invalid && (adresse.dirty || adresse.touched)" class="text-danger mt-1">
              <small *ngIf="adresse.errors?.['required']">L'adresse est obligatoire</small>
              <small *ngIf="adresse.errors?.['minlength']">L'adresse doit contenir au moins 5 caractères</small>
            </div>
          </div>

          <!-- Numéro Identification Entreprise -->
          <div class="form-col mb-3 widh80">
            <label for="numCin" class="form-label">Numéro d'identification de l'entreprise</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-building"></i></span>
              <input 
                id="numCin" 
                [(ngModel)]="form.numeroIdentificationEntreprise" 
                name="numCin" 
                #numCin="ngModel"
                type="text" 
                class="form-control" 
                placeholder="Ex: 123456789" 
                required 
                pattern="^[0-9]{8,10}$"
                minlength="8"
                maxlength="10"
              />
            </div>
            <div *ngIf="numCin.invalid && (numCin.dirty || numCin.touched)" class="text-danger mt-1">
              <small *ngIf="numCin.errors?.['required']">Le numéro d'identification est obligatoire</small>
              <small *ngIf="numCin.errors?.['pattern']">Le numéro doit contenir uniquement des chiffres</small>
              <small *ngIf="numCin.errors?.['minlength'] || numCin.errors?.['maxlength']">Le numéro doit contenir entre 8 et 10 chiffres</small>
            </div>
          </div>

          <!-- Téléphone -->
        <div class="form-col mb-3 widh80">
        <label for="telephone" class="form-label">Téléphone</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-telephone"></i></span>
          <input
          id="telephone"
          [(ngModel)]="form.telephone"
          name="telephone"
          type="tel"
          class="form-control"
          placeholder="Téléphone"
          required
          pattern="^[0-9]{8}$"
          #telephone="ngModel"
          minlength="8"
          maxlength="8"
        />
        </div>
        <div *ngIf="telephone.invalid && (telephone.dirty || telephone.touched)" class="text-danger mt-1">
          <small *ngIf="telephone.errors?.['required']">Le téléphone est obligatoire</small>
          <small *ngIf="telephone.errors?.['pattern']">Le numéro doit contenir 8 chiffres</small>
        </div>
      </div>

          <!-- Mot de passe -->
          <div class="form-col mb-3 widh80">
            <label for="password" class="form-label">Mot de passe</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-lock"></i></span>
              <input 
                id="password" 
                [(ngModel)]="form.password" 
                name="password" 
                #password="ngModel"
                [type]="showPassword ? 'text' : 'password'" 
                class="form-control" 
                placeholder="Mot de passe" 
                required 
                minlength="8"
                pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$"
              />
              <button type="button" class="btn btn-outline-secondary" (click)="togglePassword()">
                <i class="bi" [ngClass]="showPassword ? 'bi-eye-slash' : 'bi-eye'"></i>
              </button>
            </div>
            <div *ngIf="password.invalid && (password.dirty || password.touched)" class="text-danger mt-1">
              <small *ngIf="password.errors?.['required']">Le mot de passe est obligatoire</small>
              <small *ngIf="password.errors?.['minlength']">Le mot de passe doit contenir au moins 8 caractères</small>
              <small *ngIf="password.errors?.['pattern']">
                Le mot de passe doit contenir au moins : 1 minuscule, 1 majuscule, 1 chiffre et 1 caractère spécial
              </small>
            </div>
          </div>


        </div>
        <!-- Étape 2: Logo de l'entreprise -->
        <div *ngIf="currentStep === 2">
          <h4 class="mb-3 text-primary"><i class="bi bi-image me-2"></i>Logo de l'entreprise</h4>
          
          <!-- Upload de photo -->
          <div class="card mb-3 bg-white">
            <div class="card-header bg-primary">
              <h6 class="mb-0"><i class="bi bi-cloud-upload me-2"></i> Uploader un nouveau logo</h6>
            </div>
            <div class="card-body">
              <div class="form-row align-items-center">
                <!-- Sélection de fichier -->
                <div class="form-col">
                  <label class="btn w-100" style="background-color: #f8f9fa; border: 2px dashed #ddd; cursor: pointer;">
                    <input type="file" (change)="selectFiles($event)" style="display: none;" />
                    <i class="bi bi-file-image fs-4" style="color: #63a50a;"></i>
                    <div>Sélectionner une image</div>
                    <small class="text-muted">Cliquez ou glissez un fichier ici</small>
                  </label>
                </div>

                <!-- Bouton upload -->
                <div class="form-col">
                  <button type="button" class="btn btn-success w-100" [disabled]="!selectedFiles" (click)="uploadPhotos()">
                    <i class="bi bi-upload me-2"></i> Uploader
                  </button>
                </div>
              </div>

              <!-- Message d'upload -->
              <div *ngIf="uploadMessage" class="alert mt-3" [ngClass]="{'alert-success': uploadSuccess, 'alert-danger': uploadError}">
                <i class="bi" [ngClass]="{'bi-check-circle': uploadSuccess, 'bi-exclamation-triangle': uploadError}"></i>
                {{ uploadMessage }}
              </div>

              <!-- Barre de progression -->
              <div *ngIf="progressInfos.length > 0" class="mt-3">
                <h6 style="color: #3c2313;">Progression de l'upload</h6>
                <div *ngFor="let progressInfo of progressInfos" class="mb-2">
                  <small class="d-block mb-1">{{ progressInfo.fileName }}</small>
                  <div class="progress" style="height: 10px;">
                    <div
                      class="progress-bar bg-success"
                      role="progressbar"
                      [style.width.%]="progressInfo.value"
                      aria-valuemin="0"
                      aria-valuemax="100"
                    ></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Galerie des logos -->
          <div class="mt-4">
            <h6 class="mb-2"><i class="bi bi-images me-2"></i> Logos disponibles</h6>
            <p class="text-muted mb-3">Sélectionnez un logo parmi les images existantes ou uploadez-en un nouveau.</p>

            <div class="photo-grid">
              <div *ngFor="let photo of allPhoto">
                <div *ngIf="!photosToHide.includes(photo.id)" class="photo-card" (click)="selectLogo(photo)" [ngClass]="{'border-success': isPhotoSelected(photo.id)}">
                  <div class="position-relative">
                    <img [src]="'http://localhost:8080/uploads/' + photo.name" class="photo-img" alt="{{ photo.name }}">
                    <div *ngIf="isPhotoSelected(photo.id)" class="position-absolute" style="top: 5px; right: 5px;">
                      <span class="badge bg-success"><i class="bi bi-check"></i></span>
                    </div>
                  </div>
                  <div class="photo-card-body text-center">
                    <small>{{ photo.name.slice(0, 20) }}{{ photo.name.length > 20 ? '...' : '' }}</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Étape 3: Critères écologiques -->
        <div *ngIf="currentStep === 3">
          <h4 class="mb-3 text-primary"><i class="bi bi-leaf me-2"></i>Critères écologiques</h4>
          
          <!-- Matériaux utilisés -->
          <div class="form-col mb-3 widh80">
            <label for="materiaux" class="form-label">Matériaux utilisés</label>
            <select id="materiaux" class="form-select" [(ngModel)]="form.materiauxUtilises" name="materiauxUtilises" required>
              <option *ngFor="let materiau of materiauxOptions" [value]="materiau">{{ materiau }}</option>
            </select>
          </div>

          <!-- Méthodes de production -->
          <div class="form-col mb-3 widh80">
            <label for="methodes" class="form-label">Méthodes de production</label>
            <select id="methodes" class="form-select" [(ngModel)]="form.methodesProduction" name="methodesProduction" required>
              <option *ngFor="let methode of methodesProductionOptions" [value]="methode">{{ methode }}</option>
            </select>
          </div>

          <!-- Programme de recyclage -->
          <div class="form-col mb-3 widh80">
            <label for="recyclage" class="form-label">Programme de recyclage</label>
            <select id="recyclage" class="form-select" [(ngModel)]="form.programmeRecyclage" name="programmeRecyclage" required>
              <option *ngFor="let recyclage of programmeRecyclageOptions" [value]="recyclage">{{ recyclage }}</option>
            </select>
          </div>

          <!-- Transport et logistique verte -->
          <div class="form-col mb-3 widh80">
            <label for="transport" class="form-label">Transport & Logistique Verte</label>
            <select id="transport" class="form-select" [(ngModel)]="form.transportLogistiqueVerte" name="transportLogistiqueVerte" required>
              <option *ngFor="let transport of transportLogistiqueOptions" [value]="transport">{{ transport }}</option>
            </select>
          </div>

          <!-- Initiatives sociales -->
          <div class="form-col mb-3 widh80">
            <label for="initiatives" class="form-label">Initiatives Sociales</label>
            <select id="initiatives" class="form-select" [(ngModel)]="form.initiativesSociales" name="initiativesSociales" required>
              <option *ngFor="let initiative of initiativesSocialesOptions" [value]="initiative">{{ initiative }}</option>
            </select>
          </div>

          <div class="form-col mb-3 widh80">
            <label for="scoreEcologique" class="form-label">Score Écologique</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-bar-chart"></i></span>
              <input 
                id="scoreEcologique" 
                [(ngModel)]="form.scoreEcologique" 
                name="scoreEcologique" 
                #scoreEcologique="ngModel"
                type="number" 
                class="form-control" 
                min="0" 
                max="100"
                step="0.1" 
                placeholder="Score entre 0 et 100" 
                required 
              />
            </div>
            <div *ngIf="scoreEcologique.invalid && (scoreEcologique.dirty || scoreEcologique.touched)" class="text-danger mt-1">
              <small *ngIf="scoreEcologique.errors?.['required']">Le score écologique est obligatoire</small>
              <small *ngIf="scoreEcologique.errors?.['min']">Le score ne peut pas être inférieur à 0</small>
              <small *ngIf="scoreEcologique.errors?.['max']">Le score ne peut pas être supérieur à 100</small>
            </div>
          </div>
        </div>

        <!-- Étape 4: Validation -->
        <div *ngIf="currentStep === 4">
          <h4 class="mb-3 text-primary"><i class="bi bi-check-circle me-2"></i>Validation</h4>
          
          <!-- Résumé des informations -->
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h5 class="mb-0">Résumé de votre inscription</h5>
            </div>
            <div class="card-body">
              <div class="row mb-2">
                <div class="col-md-6">
                  <p><strong>Nom:</strong> {{ form.username }}</p>
                  <p><strong>Email:</strong> {{ form.email }}</p>
                  <p><strong>Téléphone:</strong> {{ form.telephone }}</p>
                </div>
                <div class="col-md-6">
                  <p><strong>Adresse:</strong> {{ form.adresse }}</p>
                  <p><strong>N° d'identification:</strong> {{ form.numeroIdentificationEntreprise }}</p>
                  <p><strong>Score écologique:</strong> {{ form.scoreEcologique }}</p>
                </div>
              </div>
              
              <div class="mb-3">
                <h6 class="mb-2">Pratiques écologiques:</h6>
                <ul class="list-group">
                  <li class="list-group-item"><i class="bi bi-check-circle-fill text-success me-2"></i>Matériaux: {{ form.materiauxUtilises }}</li>
                  <li class="list-group-item"><i class="bi bi-check-circle-fill text-success me-2"></i>Production: {{ form.methodesProduction }}</li>
                  <li class="list-group-item"><i class="bi bi-check-circle-fill text-success me-2"></i>Recyclage: {{ form.programmeRecyclage }}</li>
                  <li class="list-group-item"><i class="bi bi-check-circle-fill text-success me-2"></i>Transport: {{ form.transportLogistiqueVerte }}</li>
                  <li class="list-group-item"><i class="bi bi-check-circle-fill text-success me-2"></i>Initiatives: {{ form.initiativesSociales }}</li>
                </ul>
              </div>
              
              <div class="text-center" *ngIf="form.logo && form.logo.id">
                <h6>Logo sélectionné:</h6>
                <img *ngIf="form.logo.name" [src]="'http://localhost:8080/uploads/' + form.logo.name" alt="Logo" class="img-thumbnail" style="max-height: 100px; max-width: 200px;">
              </div>
            </div>
          </div>

          <!-- Case à cocher avec lien vers la modal -->
          <div class="form-check mb-3">
            <input type="checkbox" class="form-check-input" id="reglementCheck" [(ngModel)]="acceptTerms" name="acceptTerms" required>
            <label class="form-check-label" for="reglementCheck">
              J'accepte les <a href="#" data-bs-toggle="modal" data-bs-target="#reglementModal">règlements de la société</a>
            </label>
          </div>
        </div>

        <!-- Boutons de navigation -->
        <div class="d-flex justify-content-between mt-4">
          <button type="button" class="btn btn-outline-primary" (click)="prevStep()" *ngIf="currentStep > 1">
            <i class="bi bi-arrow-left me-2"></i>Précédent
          </button>
          <div *ngIf="currentStep < 4">
            <button type="button" class="btn btn-primary" (click)="nextStep()">
              Suivant<i class="bi bi-arrow-right ms-2"></i>
            </button>
          </div>
          <button type="submit" class="btn btn-success" *ngIf="currentStep === 4" [disabled]="!acceptTerms">
            <i class="bi bi-check-circle me-2"></i>Finaliser l'inscription
          </button>
        </div>
      </form>

      <!-- Confirmation d'inscription réussie -->
      <div *ngIf="isSuccessful" class="alert alert-success mt-3">
        <i class="bi bi-check-circle-fill me-2"></i> Inscription réussie ! Bienvenue 🎉
        <p class="mt-2">Votre demande d'inscription a été reçue et sera évaluée prochainement. Vous recevrez un email de confirmation.</p>
        <div class="text-center mt-3">
          <button class="btn btn-primary" (click)="goToLogin()">
            <i class="bi bi-box-arrow-in-right me-2"></i>Aller à la page de connexion
          </button>
        </div>
      </div>

      <!-- Message d'erreur -->
      <div *ngIf="errorMessage" class="alert alert-danger mt-3" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i> {{ errorMessage }}
      </div>

      <!-- Lien pour se connecter -->
      <p class="text-center mt-3" *ngIf="!isSuccessful">
        Vous avez déjà un compte ? <a href="/auth/fournisseur/login" class="text-primary">Connectez-vous ici</a>
      </p>
    </div>
  </div>
</div>

<!-- Modal des règlements -->
<div class="modal fade" id="reglementModal" tabindex="-1" aria-labelledby="reglementModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title fw-bold" id="reglementModalLabel">
          <i class="bi bi-file-text me-2 text-success"></i>Règlements de la société
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body" style="line-height: 1.8; font-size: 1rem;">
        <p>En rejoignant notre plateforme, vous acceptez les engagements suivants :</p>

        <ul class="list-unstyled">
          <li class="mb-2">
            <i class="bi bi-leaf text-success me-2"></i>
            Nous accompagnons des <strong>artisans écologiques</strong> et de qualité supérieure.
          </li>
          <li class="mb-2">
            <i class="bi bi-cash-coin text-primary me-2"></i>
            À chaque paiement d'article, <strong>10%</strong> est reversé à la société.
          </li>
          <li class="mb-2">
            <i class="bi bi-person-check text-warning me-2"></i>
            Votre demande d'inscription sera <strong>évaluée</strong> selon vos critères environnementaux et éthiques.
            Vous recevrez un email de <strong>confirmation</strong> (acceptée ou rejetée).
          </li>
          <li class="mb-2">
            <i class="bi bi-box-seam text-info me-2"></i>
            Lors du dépôt d'un article, une <strong>évaluation</strong> sera également effectuée et vous en serez informé.
          </li>
          <li class="mb-2">
            <i class="bi bi-bell text-secondary me-2"></i>
            Vous recevrez des <strong>notifications</strong> sur le site concernant les décisions.
          </li>
          <li class="mb-2">
            <i class="bi bi-shield-exclamation text-danger me-2"></i>
            Votre image reflète celle de notre société. En cas de <strong>réclamations fréquentes</strong> ou de non-respect de notre charte, vous pourrez être <strong>exclu</strong> de la plateforme.
          </li>
        </ul>

        <p class="mt-4 text-success">
          🌱 Merci de contribuer à une consommation responsable et durable.
        </p>
      </div>
      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>